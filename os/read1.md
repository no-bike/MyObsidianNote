# 1.x86系统架构概览

### 1.1 系统级体系结构概览

1. Global and Local Descriptor Tables (GDT和LDT)

Global Descriptor Table (GDT): GDT是一个全局的描述符表，存储系统中所有的段描述符。每个描述符定义了段的基址、界限和特权级别。GDT在系统启动时被初始化，操作系统通过它来管理内存中的代码段和数据段。
Local Descriptor Table (LDT): LDT是一个局部描述符表，通常用于提供特定进程的私有段描述符。每个进程可以有自己的LDT，从而允许它拥有独立的段定义。LDT在特定情况下使用，例如，当程序需要多个不同的代码或数据段时。

2. System Segments, Segment Descriptors, and Gates

System Segments: 系统段是特定用途的段，通常包括系统调用、任务管理和中断处理所需的代码和数据。这些段的管理和访问权限由段描述符控制。
Segment Descriptors: 段描述符是存储在GDT或LDT中的结构，定义了段的属性，包括基地址、段界限（大小）、访问权限和特权级。段描述符是x86体系结构内存管理的重要组成部分。
Gates: Gates是一种特殊的段描述符，通常用于实现系统调用和中断处理。它们允许程序在不同的特权级之间进行安全切换，例如从用户模式切换到内核模式。

3. Task-State Segments (TSS) and Task Gates

Task-State Segment (TSS): TSS是一个特殊的段，存储有关任务的信息，例如堆栈指针、任务状态和程序计数器。TSS用于任务切换和上下文切换，允许CPU保存和恢复任务的状态。
Task Gates: Task Gates是用于切换任务的特殊描述符，定义了目标任务的TSS位置。当一个任务请求切换时，CPU通过Task Gates进入新的任务，自动加载新的TSS。

4. Interrupt and Exception Handling

中断处理: x86体系结构支持硬件中断和软件中断。中断处理程序可以通过中断向量表找到，通常是在内存中的一个数组，包含中断服务例程（ISR）的地址。
异常处理: 异常是由程序错误（如除零错误或非法操作码）引发的中断。x86处理器会在发生异常时调用特定的异常处理程序，以便进行适当的错误处理。

5. Memory Management

内存管理: x86体系结构使用段式和分页式内存管理。段式管理通过段描述符实现，允许程序在逻辑上使用不同的内存段。分页式管理则通过页表将物理内存映射到虚拟内存，使得内存使用更加灵活且能够实现虚拟内存功能。

6. System Registers

系统寄存器: x86体系结构有多种系统寄存器，包括控制寄存器（如CR0, CR3），状态寄存器（如EFLAGS），以及段寄存器（如CS, DS, SS, ES等）。这些寄存器用于管理系统状态、控制内存管理、处理特权级和中断等功能。
### 1.2 实模式和保护模式转换
##### 实模式 (Real Mode)

特点: 
- 地址空间限制为1MB。
- 直接访问物理内存，无法进行内存保护和多任务管理。
- 使用段寄存器和偏移量寻址，段地址由16位段寄存器和16位偏移量组合形成。

##### 保护模式 (Protected Mode)

特点:
- 支持多达4GB的虚拟地址空间。
- 提供内存保护、分段和分页机制。
- 使用描述符表（GDT和LDT）管理内存段。

##### 实模式到保护模式的转换步骤

1. 关闭中断:
	在进行模式转换之前，首先要关闭中断，以防止在切换过程中发生意外的中断。
2. 设置段寄存器:
	将段寄存器（如CS, DS, SS, ES等）加载为合适的保护模式描述符。
3. 初始化GDT:
	创建和加载全局描述符表（GDT），定义必要的段描述符，包括代码段、数据段和栈段。
4. 加载GDTR:
	设置GDTR寄存器，指向新创建的GDT的基址和界限。
5. 切换到保护模式:
	设置控制寄存器CR0中的PE位（保护模式启用位），这会使CPU进入保护模式。
6. 加载段寄存器:
	进入保护模式后，需要重新加载段寄存器以确保它们指向有效的保护模式段描述符。
7. 设置堆栈:
	初始化堆栈段，并确保堆栈指针（ESP）指向一个有效的堆栈区域。
8. 开启中断.

##### 保护模式到实模式的转换步骤

1. 关闭中断.
2. 清除PE位:
	清除CR0中的PE位，使CPU退出保护模式并回到实模式。
3. 恢复段寄存器:
	将段寄存器恢复为实模式值，通常将其设置为相应的段值，以便重新寻址1MB内存。
4. 清除GDT:
	在实模式下，不使用GDT，因此可以将其设置为无效。
5. 设置堆栈:
	确保堆栈段（SS）指向一个有效的实模式堆栈区域。
6. 开启中断.

### 1.3 80x86系统指令寄存器

##### 1. 指令寄存器 (IR)
指令寄存器用于存储当前正在执行的指令。每当CPU从内存中取出一条指令时，它将这条指令加载到指令寄存器中进行解码和执行。

##### 2. 标志寄存器 (EFLAGS)
EFLAGS寄存器用于存储条件码和控制信息，影响程序执行的状态。主要功能包括：

- **条件码标志**：用于表示算术运算的结果，如零标志(ZF)、进位标志(CF)、溢出标志(OF)等。
- **中断控制**：包括可中断标志(IF)，用于启用或禁用中断。
- **方向标志(DF)**：影响字符串操作的方向。
- **系统标志**：如虚拟8086模式(VM)标志，影响系统的运行模式。

##### 3. 内存管理寄存器
内存管理寄存器负责管理虚拟内存和段选择。主要包括：

- **GDTR (Global Descriptor Table Register)**：指向全局描述符表（GDT）的基地址和限制。GDT定义了系统中的段描述符。
  
- **LDTR (Local Descriptor Table Register)**：指向局部描述符表（LDT），用于特定任务的段描述符。
  
- **IDTR (Interrupt Descriptor Table Register)**：指向中断描述符表（IDT），该表定义了中断和异常处理程序的地址。

- **TR (Task Register)**：指向当前任务的TSS（任务状态段），用于存储任务的上下文信息，包括寄存器状态、堆栈指针等。

##### 4. 控制寄存器 (CR)
控制寄存器用于控制CPU的操作模式和内存管理。包括：

- **CR0**：控制系统的启用状态，包括保护模式、任务切换、虚拟8086模式等的启用与禁用。
  
- **CR1**：在一些架构中被保留或不使用。
  
- **CR2**：存储最近一次页面错误的地址。用于内存管理和页面错误处理。
  
- **CR3**：指向当前页目录表的基地址，涉及到虚拟地址到物理地址的转换。

### 1.4 系统指令

##### 1. **LGDT (Load Global Descriptor Table Register)**
- **功能**: 将全局描述符表（GDT）的基地址和限制加载到GDTR寄存器中。
- **语法**: `LGDT [mem]`
- **使用场景**: 在进入保护模式之前，需要加载GDT以设置段描述符。

##### 2. **SGDT (Store Global Descriptor Table Register)**
- **功能**: 将当前全局描述符表的基地址和限制存储到指定的内存位置。
- **语法**: `SGDT [mem]`
- **使用场景**: 用于获取当前GDT的地址和限制，通常用于调试和状态检查。

##### 3. **LIDT (Load Interrupt Descriptor Table Register)**
- **功能**: 将中断描述符表（IDT）的基地址和限制加载到IDTR寄存器中。
- **语法**: `LIDT [mem]`
- **使用场景**: 在设置中断处理程序之前，需要加载IDT。

##### 4. **SIDT (Store Interrupt Descriptor Table Register)**
- **功能**: 将当前中断描述符表的基地址和限制存储到指定的内存位置。
- **语法**: `SIDT [mem]`
- **使用场景**: 用于获取当前IDT的地址和限制，便于调试和状态检查。

##### 5. **LLDT (Load Local Descriptor Table Register)**
- **功能**: 将局部描述符表（LDT）的基地址加载到LDTR寄存器中。
- **语法**: `LLDT [mem]`
- **使用场景**: 在任务切换或使用LDT时，需要加载新的LDT。

##### 6. **SLDT (Store Local Descriptor Table Register)**
- **功能**: 将当前局部描述符表的选择子存储到指定的内存位置。
- **语法**: `SLDT [mem]`
- **使用场景**: 用于获取当前LDT的选择子，通常用于调试。

##### 7. **LTR (Load Task Register)**
- **功能**: 将任务状态段（TSS）的选择子加载到TR寄存器中。
- **语法**: `LTR reg`
- **使用场景**: 在任务切换时需要加载新的TSS。

##### 8. **STR (Store Task Register)**
- **功能**: 将当前任务状态段的选择子存储到指定的内存位置。
- **语法**: `STR [mem]`
- **使用场景**: 用于获取当前TSS的选择子，通常用于调试。
